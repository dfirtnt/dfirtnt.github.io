<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>“Find Evil” in 5 easy steps!! (Part 1) | DFIR TNT Digital Forensics Incident Response Tips and Tricks</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="“Find Evil” in 5 easy steps!! (Part 1)" />
<meta name="author" content="Andrew Skatoff" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Some SOC alerts are so precise that a very specific set of response actions is warranted. For example, if a malicious email is detected, check if the user clicked on it. EDR events or forensic artifacts from the filesystem can be used to answer that question. However, when you have more ambiguous “detections” such as those which come from machine learning use-cases (e.g. suspicious traffic patterns), the guidance is often something like “verify the integrity of the endpoint.”" />
<meta property="og:description" content="Some SOC alerts are so precise that a very specific set of response actions is warranted. For example, if a malicious email is detected, check if the user clicked on it. EDR events or forensic artifacts from the filesystem can be used to answer that question. However, when you have more ambiguous “detections” such as those which come from machine learning use-cases (e.g. suspicious traffic patterns), the guidance is often something like “verify the integrity of the endpoint.”" />
<link rel="canonical" href="https://dfirtnt.github.io/2020/03/03/find-evil-in-5-easy-steps-part-1/" />
<meta property="og:url" content="https://dfirtnt.github.io/2020/03/03/find-evil-in-5-easy-steps-part-1/" />
<meta property="og:site_name" content="DFIR TNT Digital Forensics Incident Response Tips and Tricks" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-03-03T22:50:40-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="“Find Evil” in 5 easy steps!! (Part 1)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Andrew Skatoff"},"dateModified":"2020-03-03T22:50:40-05:00","datePublished":"2020-03-03T22:50:40-05:00","description":"Some SOC alerts are so precise that a very specific set of response actions is warranted. For example, if a malicious email is detected, check if the user clicked on it. EDR events or forensic artifacts from the filesystem can be used to answer that question. However, when you have more ambiguous “detections” such as those which come from machine learning use-cases (e.g. suspicious traffic patterns), the guidance is often something like “verify the integrity of the endpoint.”","headline":"“Find Evil” in 5 easy steps!! (Part 1)","mainEntityOfPage":{"@type":"WebPage","@id":"https://dfirtnt.github.io/2020/03/03/find-evil-in-5-easy-steps-part-1/"},"url":"https://dfirtnt.github.io/2020/03/03/find-evil-in-5-easy-steps-part-1/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://dfirtnt.github.io/feed.xml" title="DFIR TNT | Digital Forensics | Incident Response | Tips and Tricks" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">DFIR TNT | Digital Forensics | Incident Response | Tips and Tricks</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">&quot;Find Evil&quot; in 5 easy steps!! (Part 1)</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-03-03T22:50:40-05:00" itemprop="datePublished">Mar 3, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    Some SOC alerts are so precise that a very specific set of response actions is warranted. For example, if a malicious email is detected, check if the user clicked on it. EDR events or forensic artifacts from the filesystem can be used to answer that question. However, when you have more ambiguous "detections" such as those which come from machine learning use-cases (e.g. suspicious traffic patterns), the guidance is often something like "verify the integrity of the endpoint."

I like to call these "find evil" cases. The goal in these cases is to look for any indications of attack/compromise, abuse, lateral movement, general fishy business, etc. The following are my go-to investigative steps to use in these circumstances. They are not elite, but they are a good place to start in scooping up any low hanging fruit that sloppy adversaries have left behind.

These techniques assume you have pulled file system artifacts (e.g. MFT, temp files, appdata, registry, lnk files, event logs, etc.). Tools like KAPE are an excellent option for remote artifact collection. In part 1, I will cover 3 of the top approaches I like to take when triaging a device which has unspecified suspicious events associated with it.

## 1. LOKI IOC Scanner

LOKI IOC Scanner is a unique tool that examines systems for anomalous patterns of events, file artifacts, processes and more. LOKI can be run on live systems or against triage file collections. In this context (file collections) the -p switch can be used to point the scanner to the path where the file artifacts are stored.

It supports these different types of indicators:
* MD5 / SHA1 / SHA256 hashes
* Yara Rules (applied to file data and process memory)
* Hard Indicator Filenames based on Regular Expression (e.g. \\pwdump\.exe)
* Soft Indicator Filenames based on Regular Expressions (e.g. Windows\\[\w]\.exe)

First, get the latest updates from github. This will provide you the latest code and the latest free rules from Nextron Systems (and Florian Roth). Note, it is best to run this as an admin.

```
C:\Temp\Tools\loki_0.29.1\loki> .\loki-upgrader.exe
```

After this update, I like to add my own curated YARA signatures to these scans. This could be private commercially purchased rules, internally develop signatures, or your favorite free YARA signature repository. This can be done easily by dropping your *.yar(a) files into the LOKI subfolder: "C:\Temp\Tools\loki_0.29.1\loki\signature-base\yara\"

Next, run LOKI scanner against the file collection. Note, it is best to run this as an admin.

```
Loki -p  c:\temp\case\files\c\ --scriptanalysis  --rootkit --noprocscan -l ./LOKI.log --dontwait --intense --maxworkingset 5000
```

Note, if you happen to have procdumps, omit the "--noprocscan" switch from the above.

LOKI output displays in standard out. Loki scanned another version of itself that I was testing… False Positive. It found pattern matches in the second instance's pattern files… well done! Loki found a network traffic analysis tool that hackers like. LOKI found something that is truly concerning. In this case a visual basic script is being launched at startup.

## 2. Process Execution - Discovery

If an advanced attacker has gained access to the suspect device, a common next step is to perform reconnaissance of the victim device. This often takes the form of executing native OS commands with a technique often called "living off the land" (LOL). These native binaries are sometimes called #LOLBINS.

Reviewing the security eventlog for a high for process 4688 (process execution) for these LOLBINS can be a fast way to identify shenanigans. Logparser to the rescue:

```
LogParser.exe -stats:OFF -i:EVT "SELECT TimeGenerated AS Date, EXTRACT_TOKEN(Strings, 1, '|') AS Username, EXTRACT_TOKEN(Strings, 2, '|') AS Domain, EXTRACT_TOKEN(Strings, 5, '|') AS Process FROM '.\files\c\windows\system32\winevt\logs\Security.evtx' WHERE EventID = 4688 AND (Process LIKE '%\\at.exe'  OR Process LIKE '%\\ceipdata.exe'  OR Process LIKE '%\\ceiprole.exe'  OR  Process LIKE '%\\chcp.exe' OR Process LIKE '%\\cmd.exe'  OR Process LIKE '%\\compmgmtlauncher.exe'  OR Process LIKE '%\\csvde.exe'  OR Process LIKE '%\\dsget.exe' OR Process LIKE '%\\dsquery.exe'  OR Process LIKE '%\\esentutl.exe'  OR Process LIKE '%\\\\find.exe'  OR Process LIKE '%\\fsutil.exe'  OR Process LIKE '%\\tracert.exe'  OR Process LIKE '%\\tree.exe' OR Process LIKE '%\\type.exe' OR Process LIKE '%\\vds.exe' OR Process LIKE '%\\vdsldr.exe' OR Process LIKE '%\\ver.exe' OR Process LIKE '%\\wevtutil.exe' OR Process LIKE '%\\whoami.exe' OR Process LIKE '%\\WinrsHost.exe' OR Process LIKE '%\\inver.exe' OR Process LIKE '%\\wmic.exe' OR Process LIKE '%\\wusa.exe')"
```

Modify to include your own list of LOLBINS (here's mine). Or use a similar approach to query the contents of the prefetch folder:

For an even more rudimentary approach, just check the prefetch folder for evidence of execution of suspicious exes. Here's a caveman-level quick way to do it.

```
dir .\C\windows\prefetch | grep -i -E "(at.exe|ceipdata.exe|ceiprole.exe|chcp.exe|cmd.exe|compmgmtlauncher.exe|csvde.exe|dsget.exe|dsquery.exe|esentutl.exe|find.exe|fsutil.exe|hostname.exe| ipconfig.exe|ldifde.exe|nbtstat.exe|net.exe|net1.exe|netdom.exe|netsh.exe|netstat.exe|nltest.exe|nslookup.exe|ping.exe|psexec.exe|qprocess.exe|query.exe|quser.exe|qwinsta.exe|reg.exe|sc.exe|schtasks.exe|servermanagercmd.exe|set.exe|systeminfo.exe|tasklist.exe|time.exe|tracert.exe|tree.exe|type.exe|vds.exe|vdsldr.exe|ver.exe|wevtutil.exe|whoami.exe|WinrsHost.exe|inver.exe|wmic.exe|wusa.exe|setup.exe|wscript.exe)"
```

Of course using grep -f to import a list of strings is more elegant, but for blog purposes, I wanted to show the full mess.

## 3. Pattern Matching in Event Logs

Searching event logs for suspicious patterns is a business fraught with regex and ngrams challenges. Thankfully, Eric Conrad's DeepBlueCLI can create some shortcuts for us. It provides detection for the following:

* Suspicious account behavior
* Command line/Sysmon/PowerShell auditing
* Service auditing
* Mimikatz
* EMET & Applocker Blocks
* ...and more

It leverages numerous text analysis functions to find evil! Some examples include:

* Examining length and character entropy from 4688 events (indicative of base64 encoded shellcode or com object hijacking)
* Powershell via WMI or PSExec
* Suspiciously named service creation (suggests mimikatz)
* ... and more

DeepBlueCLI supports 5 different event logs in EVTX format. It can scan the system's live logs, or it can scan EVTX files in a triage collection.

Start by launching Powershell as an Admin. Then perform the following:

```
PS C:\Temp\Tools\DeepBlueCLI-master\DeepBlueCLI-master> .\DeepBlue.ps1 -file C:\Temp\triage_collection\C\Windows\System32\winevt\Logs\Security.evtx | Out-GridView
```

The trailing "|Out-Gridview" will cause the results to pop up in a GUI interface. If you omit the pipe the results will simply go to stdout.

Alternatively, use the following to export to CSV: "| Export-Csv -Path .\Security.csv." You may want to create a batch file using the CSV output option. Or even use wildcards to perform analysis on all the relevant event logs in a single folder that you have collected from multiple machines like so:

```
.\DeepBlue.ps1 -file 'C:\temp\Data\EventLogs\evtx\*power*.evtx' | Export-Csv -Path .\DBC_Psh_Out.txt
.\DeepBlue.ps1 -file 'C:\temp\Data\EventLogs\evtx\*Security*.evtx' | Export-Csv -Path .\DBC_Sec_Out.txt
.\DeepBlue.ps1 -file 'C:\temp\Data\EventLogs\evtx\*system*.evtx' | Export-Csv -Path .\DBC_Sys_Out.txt
.\DeepBlue.ps1 -file 'C:\temp\Data\EventLogs\evtx\*Application*.evtx' | Export-Csv -Path .\DBC_App_Out.txt
.\DeepBlue.ps1 -file 'C:\temp\Data\EventLogs\evtx\*AppLocker*.evtx' | Export-Csv -Path .\DBC_Appl_Out.txt
```

DeepBlueCLI also contains sample event logs for known bad events so you can practice using the tool to identify actual suspicious/malicious events and compare with items you may be detecting on your systems.

In this post we covered 3 relatively easy ways to quickly find evil on suspect machines. In part 2 I'll cover the two more steps to finding evil with a focus on identifying persistence mechanisms.

  </div><a class="u-url" href="/2020/03/03/find-evil-in-5-easy-steps-part-1/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">DFIR TNT | Digital Forensics | Incident Response | Tips and Tricks</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Andrew Skatoff</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Digital Forensics | Incident Response | Tips and Tricks</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
