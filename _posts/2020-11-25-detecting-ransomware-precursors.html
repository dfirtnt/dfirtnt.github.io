---
layout: post
title: Detecting Ransomware Precursors
date: 2020-11-25 16:45:00.000000000 -05:00
categories:
- Ransomware
tags:
- Detection
<p><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><br />
<!-- wp:paragraph --><html><body></p>
<p>The business model for Ransomware has evolved to include multi-level and multi-stage services and tool kits. Initial access is often accomplished by 1st stage compromise, followed by 2nd stage download/drop of tools like Emotet, Trickbot, and Qakbot. This 2nd stage allows adversaries to lurk in your network, profiling normal use and/or searching for targets of maximum impact. At this point the attack often looks like any other infiltration. However, several techniques are often observed just prior to ransomware execution. In this post I'll provide examples of these detectable behaviors which you can use to build SIEM alerts, custom EDR prevention/response rules, and threat hunting logic. Detecting these patterns (in near real time) will give you an advantage in understanding what kind of threat you are facing and which devices have been impacted when the inevitable emergency phone calls start coming in.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><span style="text-decoration:underline;">Caveat 1:</span> Alerting on this activity is a LAST line of defense. Truthfully, if you catch a real bad guy with these, you're likely going to have a terrible couple of weeks. If you don't already have a robust set of other detection rules for the 1st and 2nd stages, PLEASE don't start here. This is the last chance to alert and will most likely be only of forensic value, since these often occur minutes before ransomware is deployed. If you're lucky, you'll have a chance to identify and isolate the impacted devices before the attack spreads further.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><span style="text-decoration:underline;">Caveat 2</span>: The commands below assume two things: <br>1. you are monitoring process execution and associated command lines, <br>2. the commands are in plain text and not encoded via PowerShell or otherwise obscured (e.g. passed via API). If they are, and you have a robust EDR Solution, or script block logging enabled, you may still be able to see the decoded/hidden commands. Note, some of these techniques are detectable via other means (e.g. registry monitoring) and where that is the case I've mentioned it in the "notes" column below. Always test your rules with adversary emulation techniques!</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><br><strong>Goal 1: Profile and Disable Protections</strong><br>These actions aim to evade/disable prevention/detection tools. This could be disabling AntiVirus processes or making changes to system settings.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:columns {"verticalAlignment":"center","align":"full"} --></p>
<div class="wp-block-columns alignfull are-vertically-aligned-center">
<!-- wp:column {"verticalAlignment":"center","width":"100%"} --></p>
<div class="wp-block-column is-vertically-aligned-center" style="flex-basis:100%;">
<!-- wp:table {"hasFixedLayout":true,"align":"full","className":"is-style-stripes"} --></p>
<figure class="wp-block-table alignfull is-style-stripes">
<table class="has-fixed-layout">
<tbody>
<tr>
<td><strong>SubGoal</strong></td>
<td><strong>Notional Search Logic</strong></td>
<td><strong>Examples</strong></td>
<td><strong>Notes</strong></td>
</tr>
<tr>
<td>Recon for security tools via WMI</td>
<td><code>select * AntivirusProduct<br><br>OR <br><br>select * AntispywareProduct<br><br>OR<br><br>select * FirewallProduct</code></td>
<td><code>wmic select * antivirus<br>wmic select * antispyware<br></code></td>
<td>'*' in these commands is literal. In every other example which follows, it is NOT literal.<br><br>wmic.exe is commonly used, but a few alternative processes are worth including: <br><code>srccons.exe | cmd.exe |<br>winrm.exe | winrs.exe | <br>wmiprvse.exe | cscript.exe| <br>wscript.exe | powershell.exe.  </code>
</td>
</tr>
<tr>
<td>Disable security tools via service stop/delete/config</td>
<td>
<code>net stop *<br><br>OR<br><br>sc stop *<br><br>OR<br><br>sc delete *<br><br>OR<br><br>sc config * disabled</code><br><br>
</td>
<td>Examples for MS Firewall service, MS Defender, and Windows Update Service:<br><code><br>sc config MpsSvc start= disabled<br>sc config WinDefend start= disabled<br>sc config wuauserv start= disabled<br><br>net stop MpsSvc<br>net stop WinDefend<br>net stop wuauserv<br><br>sc stop MpsSvc<br>sc stop WinDefend<br>sc stop wuauserv<br><br>sc delete MpsSvc<br>sc delete WinDefend<br>sc delete wuauserv</code>
</td>
<td>
<br><br>Design your search logic with your own relevant tools and processes unique to your environment.<br><br><a href="https://www.zscaler.com/blogs/security-research/recent-bulehero-botnet-payload" target="_blank" rel="noreferrer noopener">https://www.zscaler.com/blogs/security-research/recent-bulehero-botnet-payload</a><br><br><span style="text-decoration:underline;">Additional Detections:</span><br>7036 – Service started or stopped<br>7040 – Start type changed (Boot | On Request | Disabled)</td>
</tr>
<tr>
<td>Disable windows firewall via netsh</td>
<td><code>netsh firewall set opmode mode=disable<br><br>OR<br><br>netsh Advfirewall set allprofiles state off<br></code></td>
<td><code>cmd /c netsh firewall set opmode mode=disable<br>cmd /c netsh Advfirewall set allprofiles state off</code></td>
<td>Disabling firewalls may assists with lateral movement and C2.<br><br><a href="https://www.zscaler.com/blogs/security-research/recent-bulehero-botnet-payload" target="_blank" rel="noreferrer noopener">https://www.zscaler.com/blogs/security-research/recent-bulehero-botnet-payload</a>
</td>
</tr>
<tr>
<td>Disable or misconfigure Defender AV via powershell</td>
<td><code>powershell Set-MpPreference -Disable*<br><br>OR<br><br>powershell Add-MpPreference -Exclusion*</code></td>
<td><sup>powershell Set-MpPreference -DisableRealtimeMonitoring $true<code><br><br></code>powershell Set-MpPreference -DisableBehaviorMonitoring $true<br><br>powershell Set-MpPreference -DisableRealtimeMonitoring $true<br><br>powershell Add-MpPreference -ExclusionPath C:<br><br>Add-MpPreference -ExclusionExtension ".exe"</sup></td>
<td>These commands disable elements of MS Defender or set exclusion parameters to evade detection.<br><br>Microsoft-Windows-Windows Defender/Operational.evtx<br><br>- Event ID 5001 may be monitored to detect Defender AV Real-Time being disabled.<br><br>- Event ID 5007 may be monitored to detect Defender configuration changes.<br><br>Monitoring this registry key will also help with detection: <br><code>HKLM\SOFTWARE\Microsoft\Windows\Defender\Exclusions</code><br><br><a rel="noreferrer noopener" href="https://www.gdatasoftware.com/blog/2020/11/36459-babax-stealer-rebrands-to-osno-installs-rootkit" target="_blank">https://www.gdatasoftware.com/blog/2020/11/36459-babax-stealer-rebrands-to-osno-installs-rootkit</a><br><br><a rel="noreferrer noopener" href="https://thedfirreport.com/2020/11/23/pysa-mespinoza-ransomware/" target="_blank">https://thedfirreport.com/2020/11/23/pysa-mespinoza-ransomware/</a>
</td>
</tr>
<tr>
<td>Stop Services with WMIC</td>
<td>wmic service where * call stopservice</td>
<td>wmic service where "caption like '%%sense%%'" call stopservice</td>
<td>The example command is aimed at disabling the Windows Defender Advanced Threat Protection (EDR) service.</td>
</tr>
<tr>
<td>Relax filesystem ACLs</td>
<td><code>icacls* *grant*</code></td>
<td><code>"icacls ""C:*"" /grant Everyone:F /T /C /Q" <br><br>"icacls ""D:*"" /grant Everyone:F /T /C /Q"</code></td>
<td>Relaxing filesystem ACLs allows the malware to access all files.<br><br><a href="https://redcanary.com/blog/ryuk-ransomware-attack/" target="_blank" rel="noreferrer noopener">https://redcanary.com/blog/ryuk-ransomware-attack/</a>
</td>
</tr>
<tr>
<td>Take ownership of files with takeown.exe</td>
<td><code>takeown.exe * /F *</code></td>
<td>
<code>Takeown /S c:\</code><br><br><code>TAKEOWN /S system /U user /P password /F Myshare*</code>
</td>
<td>Taking ownership of files allows the malware to access all files.<br><br><a href="https://research.nccgroup.com/2020/06/23/wastedlocker-a-new-ransomware-variant-developed-by-the-evil-corp-group/" target="_blank" rel="noreferrer noopener">https://research.nccgroup.com/2020/06/23/wastedlocker-a-new-ransomware-variant-developed-by-the-evil-corp-group/</a>
</td>
</tr>
<tr>
<td>Clear event logs to cover tracks.</td>
<td><code>wevtutil* cl *</code></td>
<td><code>wevtutil.exe cl Application<br><br>wevtutil.exe cl Security<br><br>wevtutil.exe cl System<br><br>FOR /F “delims=” %%I IN (‘WEVTUTIL EL’) DO (WEVTUTIL CL “%%I”)</code></td>
<td>Erasing events in the event logs is an anti-forensic technique.<br><br><a href="https://www.bleepingcomputer.com/news/security/a-closer-look-at-the-robbinhood-ransomware/">https://www.bleepingcomputer.com/news/security/a-closer-look-at-the-robbinhood-ransomware/</a><br><br><a href="https://areteir.com/wp-content/uploads/2020/07/Arete_Insight_Sodino-Ransomware_June-2020.pdf">https://areteir.com/wp-content/uploads/2020/07/Arete_Insight_Sodino-Ransomware_June-2020.pdf</a><br><br>Additional detection possibilities:<br>- Security EventID 1102; EventLog cleared<br>- System EventID 104; Any eventlog was cleared.</td>
</tr>
<tr>
<td>Disable Logging</td>
<td> <code>wevtutil* sl *</code> </td>
<td>`wevtutil.exe sl Security /e:false`</td>
<td>The wevtutil sl log_name /e:false is the same as right-clicking on the log and choosing “Disable log”<br><br><a href="https://www.bleepingcomputer.com/news/security/new-ransom-x-ransomware-used-in-texas-txdot-cyberattack/" target="_blank" rel="noreferrer noopener">https://www.bleepingcomputer.com/news/security/new-ransom-x-ransomware-used-in-texas-txdot-cyberattack/</a>
</td>
</tr>
<tr>
<td>Delete USN Journal</td>
<td><code>fsutil usn deletejournal</code></td>
<td><code>fsutil usn deletejournal /D C:"</code></td>
<td>USN Journal keeps a log of all filesystem changes in NTFS volumes. deleting the journal is an anti-forensic technique.<br><br><a href="https://medium.com/cert-advisory/what-you-should-absolutely-know-about-petya-and-misha-ransomware-attack-goldeneye-ransomware-8c3f8883fb8" target="_blank" rel="noreferrer noopener">https://medium.com/cert-advisory/what-you-should-absolutely-know-about-petya-and-misha-ransomware-attack-goldeneye-ransomware-8c3f8883fb8</a>
</td>
</tr>
</tbody>
</table>
</figure>
<p><!-- /wp:table -->
</div>
<p><!-- /wp:column -->
</div>
<p><!-- /wp:columns --></p>
<p><!-- wp:paragraph --></p>
<p><strong>Goal 2: Impair Recovery</strong><br>These actions aim to limit the victim's options for stopping the malware and recovering from the loss of data. ATT&amp;CK: <a href="https://attack.mitre.org/techniques/T1490/" target="_blank" rel="noreferrer noopener">Inhibit System Recovery (T1490)</a>.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:table {"hasFixedLayout":true,"align":"full","className":"is-style-stripes"} --></p>
<figure class="wp-block-table alignfull is-style-stripes">
<table class="has-fixed-layout">
<tbody>
<tr>
<td><strong>SubGoal</strong></td>
<td><strong><strong>Notional Search Logic</strong></strong></td>
<td><strong>Examples</strong></td>
<td><strong>Notes</strong></td>
</tr>
<tr>
<td>Prevent system from booting into Automatic Repair Mode</td>
<td><code>bcdedit /set {default} bootstatuspolicy ignoreallfailures<br><br>OR<br><br>bcdedit /set {default} recoveryenabled no</code></td>
<td><code>bcdedit /set {default} bootstatuspolicy <br>ignoreallfailures<br>bcdedit /set {default} recoveryenabled no</code></td>
<td>Prevents startup in  Automatic Repair Mode  <br><br><a rel="noreferrer noopener" href="https://jsac.jpcert.or.jp/archive/2020/pdf/JSAC2020_1_tamada-yamazaki-nakatsuru_en.pdf" target="_blank">https://jsac.jpcert.or.jp/archive/2020/pdf/JSAC2020_1_tamada-yamazaki-nakatsuru_en.pdf</a>
</td>
</tr>
<tr>
<td>Disable System Restore</td>
<td><code>schtasks.exe /Change /TN * /disable</code></td>
<td><code>schtasks.exe /Change /TN "\Microsoft\Windows\SystemRestore\SR" /disable</code></td>
<td>Defray ransomware disables a default scheduled task which perform system restore backups.<br><br><a rel="noreferrer noopener" href="https://unit42.paloaltonetworks.com/vatet-pyxie-defray777/3/" target="_blank">https://unit42.paloaltonetworks.com/vatet-pyxie-defray777/3/</a>
</td>
</tr>
<tr>
<td>Enforce next startup in safemode</td>
<td><code>reg add HKLM\System\CurrentControlSet\Control\SafeBoot\Minimal\*</code></td>
<td><code>reg add HKLM\System\CurrentControlSet\Control\SafeBoot\Minimal\SuperBackupMan</code></td>
<td>Upon execution of Snatch ransomware, it will install itself as a Windows service named “SuperBackupMan” and create the following registry key to ensure it will start up during bootup into Safe Mode.<br><br><a href="https://malware.news/t/threat-analysis-unit-tau-threat-intelligence-notification-snatch-ransomware/36365" target="_blank" rel="noreferrer noopener">https://malware.news/t/threat-analysis-unit-tau-threat-intelligence-notification-snatch-ransomware/36365</a><br><br>Monitoring for registry changes here via Windows auditing and/or EDR will help with detection if the malware uses a more hidden approach.</td>
</tr>
<tr>
<td>Disable Task Manager</td>
<td>
<code>reg.exe add HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System * DisableTaskMgr </code> *</td>
<td><code>reg.exe add HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System /v DisableTaskMgr /t REG_DWORD /d 1 /f</code></td>
<td>Limits ability of user to profile and kill tasks.<br><br><a href="https://labs.sentinelone.com/the-fonix-raas-new-low-key-threat-with-unnecessary-complexities/" target="_blank" rel="noreferrer noopener">https://labs.sentinelone.com/the-fonix-raas-new-low-key-threat-with-unnecessary-complexities/</a>&gt;<br><br>Monitoring for registry changes here via Windows auditing and/or EDR will help with detection if the malware uses a more hidden approach.</td>
</tr>
<tr>
<td>Delete shadow copies</td>
<td>
<code>wmic shadowcopy delete *<br></code><br><code>OR</code><br><code><br>vssadmin delete shadows *<br></code> <br><code>OR</code><br><code><br>vssadmin resize shadowstorage *<br></code><br><code>OR</code><br><code><br>powershell Get-WmiObject Win32_ShadowCopy *</code>
</td>
<td><code>Vssadmin.exe Delete Shadows /All /Quiet<br><br>vssadmin.exe resize shadowstorage /for=D: /on=D: /maxsize=401MB<br><br>Get-WmiObject Win32_Shadowcopy | ForEach-Object {$_.Delete();}<br><br>powershell Get-WmiObject Win32_ShadowCopy | % { $_.Delete() }<br><br>powershellGet-WmiObject Win32_ShadowCopy | Remove-WmiObject</code></td>
<td>This is one of THE most prevalent techniques seen in all ransomware families. <br><br><a href="https://redcanary.com/blog/its-all-fun-and-games-until-ransomware-deletes-the-shadow-copies/">https://redcanary.com/blog/its-all-fun-and-games-until-ransomware-deletes-the-shadow-copies/</a><br><br><a href="https://resources.infosecinstitute.com/topic/ransomware-deletion-methods-and-the-canary-in-the-coal-mine/" target="_blank" rel="noreferrer noopener">https://resources.infosecinstitute.com/topic/ransomware-deletion-methods-and-the-canary-in-the-coal-mine/</a><br><br>For vssadmin techniques, we now have a <a href="https://www.bleepingcomputer.com/news/security/new-ransomware-vaccine-kills-programs-wiping-windows-shadow-volumes/" target="_blank" rel="noreferrer noopener">preventative option</a> we well.</td>
</tr>
<tr>
<td>Make deleted files unrecoverable with cipher.exe</td>
<td>cipher*/W:C:\</td>
<td>cipher /W:C\</td>
<td>cipher.exe clears the unallocated sectors of the disk from any residual data; making it impossible to forensically recover deleted files.<br><br><a href="https://unit42.paloaltonetworks.com/vatet-pyxie-defray777/3/">https://unit42.paloaltonetworks.com/vatet-pyxie-defray777/3/</a>
</td>
</tr>
<tr>
<td>Delete backup files</td>
<td><code>del /s /f /q *</code></td>
<td><code>del /s /f /q c:*.VHD c:*.bac c:*.bak c:*.wbcat c:*.bkf c:Backup*.* c:ackup*.* c:*.set c:*.win c:*.dsk</code></td>
<td>Ryuk ransomware also used this rudimentary approach to find and delete any files matching patterns signifying backups. <br><br><a href="https://www.crowdstrike.com/blog/big-game-hunting-with-ryuk-another-lucrative-targeted-ransomware/">https://www.crowdstrike.com/blog/big-game-hunting-with-ryuk-another-lucrative-targeted-ransomware/</a>
</td>
</tr>
<tr>
<td>Delete backups via wbadmin</td>
<td><code>wbadmin delete *</code></td>
<td><code>wbadmin delete catalog -quiet<br>cmd.exe /c wbadmin DELETE SYSTEMSTATEBACKUP<br>cmd.exe /c wbadmin DELETE SYSTEMSTATEBACKUP -deleteOldest</code></td>
<td>wbadmin enables you to back up and restore your operating system, volumes, files, folders, and applications from a command prompt.</td>
</tr>
<tr>
<td>Delete computer restore point</td>
<td><code>delete-ComputerRestorePoint</code></td>
<td><code>Get-ComputerRestorePoint | delete-ComputerRestorePoint</code></td>
<td><a href="https://thedfirreport.com/wp-content/uploads/2020/11/fullpysa.png" target="_blank" rel="noreferrer noopener">https://thedfirreport.com/wp-content/uploads/2020/11/fullpysa.png</a></td>
</tr>
</tbody>
</table>
</figure>
<p><!-- /wp:table --></p>
<p><!-- wp:paragraph --></p>
<p><strong>Goal 3: Unlock files in use</strong><br>These actions aim to ensure the most damage by allowing the ransomware to encrypt even files which may be in use. Killing tasks which have files locked open is key to ensuring they are editable by the ransomware.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:table {"hasFixedLayout":true,"align":"full","className":"is-style-stripes"} --></p>
<figure class="wp-block-table alignfull is-style-stripes">
<table class="has-fixed-layout">
<tbody>
<tr>
<td><strong>SubGoal</strong></td>
<td><strong><strong>Notional Search Logic</strong></strong></td>
<td><strong>Examples</strong></td>
<td><strong>Notes</strong></td>
</tr>
<tr>
<td>Kill processes with taskkill</td>
<td><code>taskkill* /IM *</code></td>
<td><code>taskkill.exe"" /IM sqlbrowser.exe /F" <br><br>taskkill.exe"" /IM sqlceip.exe /F" <br><br>taskkill.exe"" /IM sqlservr.exe /F" <br><br>taskkill.exe"" /IM sqlwriter.exe /F"</code></td>
<td>This is similar to the disabling of security tools, but will often be much noisier attempting to kill dozens of processes in short succession. Look for spikes in this command. The report linked below shows several examples. <br><br><a href="https://thedfirreport.com/2020/11/05/ryuk-speed-run-2-hours-to-ransom/" target="_blank" rel="noreferrer noopener">https://thedfirreport.com/2020/11/05/ryuk-speed-run-2-hours-to-ransom/</a><br><br>Additional detection options may exist (e.g. Security Log EventID 4689 Process Terminated)</td>
</tr>
<tr>
<td>Kill processes with netstop</td>
<td>
<code>net stop *</code><br><code>OR</code><br><code>net delete *</code>
</td>
<td><code>net.exe"" stop ""samss"" /y"<br><br>net.exe"" stop ""veeamcatalogsvc"" /y"<br><br>net.exe"" stop ""veeamcloudsvc"" /y"<br><br>net.exe"" stop ""veeamdeploysvc"" /y"</code></td>
<td>Ryuk samples have been observed attempting to stop over 50 predefined processes. Look for spikes in these commands.<br><br><a href="https://thedfirreport.com/2020/11/05/ryuk-speed-run-2-hours-to-ransom/" target="_blank" rel="noreferrer noopener">https://thedfirreport.com/2020/11/05/ryuk-speed-run-2-hours-to-ransom/</a><br><br>Additional Detections:<br>7036 – Service started or stopped<br>7040 – Start type changed (Boot | On Request | Disabled)</td>
</tr>
<tr>
<td>Kill processes with sc</td>
<td><code>sc stop *<br>OR<br>sc delete *<br>OR<br><em>sc config * disabled</em></code></td>
<td>
<code>sc stop RabbitMQ</code><br><br><code>sc config SQLTELEMETRY start= disabled</code><br><code><br>sc config SQLTELEMETRY$ECWDB2 start= disabled<br></code><br><code>sc config SQLWriter start= disabled<br></code><br><code>sc config SstpSvc start= disabled</code>
</td>
<td>These (like 'net stop' and 'taskkill') are often seen in a simple batch file. Look for spikes in these commands.<br><br><a href="https://meterpreter.org/the-latest-trickbot-variant-with-stealthy-code-injection-trick-appear/" target="_blank" rel="noreferrer noopener">https://meterpreter.org/the-latest-trickbot-variant-with-stealthy-code-injection-trick-appear/</a><br><br><a href="https://www.crowdstrike.com/blog/big-game-hunting-with-ryuk-another-lucrative-targeted-ransomware/" target="_blank" rel="noreferrer noopener">https://www.crowdstrike.com/blog/big-game-hunting-with-ryuk-another-lucrative-targeted-ransomware/</a><br><br>Additional Detections:<br>7036 – Service started or stopped<br>7040 – Start type changed (Boot | On Request | Disabled)</td>
</tr>
<tr>
<td>Kill processes with wmic</td>
<td>wmic process * delete<br>wmic </td>
<td><img class="wp-image-266" style="width:500px;" src="https://dfirtnt.wordpress.com/wp-content/uploads/2020/11/image.png" alt=""></td>
<td>Look for spikes in these commands.</td>
</tr>
</tbody>
</table>
</figure>
<p><!-- /wp:table --></p>
<p><!-- wp:paragraph --></p>
<p><strong>Goal: Destroy/Ransom Data</strong><br>This is the final stage where files are encrypted, often renamed and a ransom note is presented or dropped on the filesystem. The detection value of alerting at this stage is limited, since we are going to hope and believe that our users are going to call the emergency hotline at this point and, God forbid, not attempt to pay the attackers.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><strong>Conclusion</strong><br>I hope this will help you in your fight against ransomware. Drop me a comment and let me know what other detection logic you have have found helpful.</p>
<p><!-- /wp:paragraph --><br />
</body></html></p>
